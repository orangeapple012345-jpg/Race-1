<!doctype html>
<html lang="en">
<head>
  <!--
    ============================================================
      Draft Circuit Racing ‚Ä¢ Single-file Game (1000+ lines)
      - GitHub Pages friendly: just index.html + /cars images
      - Draft: random 6-card pack each pick
      - 2 players, 4 cars each
      - Race: advanced circuit (many corners/straights)
      - Realistic-ish acceleration: 0-60 + drag-limited curve to top speed
      - Handling affects corner speed caps based on curvature severity
      - Live leaderboard + lap times
      - No pit stops / no weather (per request)
    ============================================================
  -->

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Draft Circuit Racing</title>

  <style>
    /* ============================================================
      THEME + RESET
    ============================================================ */
    :root{
      --bg: #0b1020;
      --panel: rgba(255,255,255,0.045);
      --panel2: rgba(255,255,255,0.065);
      --border: rgba(255,255,255,0.10);
      --border2: rgba(255,255,255,0.15);
      --text: #eaf0ff;
      --muted: #a9b6d2;
      --muted2:#7f90b4;

      --p1: #60a5fa;
      --p2: #4ade80;

      --good: #4ade80;
      --warn: #fbbf24;
      --bad:  #fb7185;

      --shadow: 0 18px 45px rgba(0,0,0,0.45);
      --shadow2: 0 10px 24px rgba(0,0,0,0.35);

      --radius: 18px;
      --radius2: 14px;
      --radius3: 12px;

      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";

      --track-asphalt: rgba(0,0,0,0.42);
      --track-line: rgba(255,255,255,0.12);
      --track-line2: rgba(255,255,255,0.06);
      --grid: rgba(255,255,255,0.06);

      --btn: rgba(255,255,255,0.07);
      --btn2: rgba(255,255,255,0.11);
    }

    *{ box-sizing: border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: var(--sans);
      background:
        radial-gradient(1100px 700px at 10% -10%, rgba(96,165,250,0.18), transparent 55%),
        radial-gradient(1000px 700px at 90% 0%, rgba(74,222,128,0.12), transparent 55%),
        radial-gradient(900px 650px at 50% 115%, rgba(251,191,36,0.10), transparent 55%),
        var(--bg);
      color: var(--text);
    }

    a{ color: inherit; }

    code{
      font-family: var(--mono);
      background: rgba(255,255,255,0.07);
      border: 1px solid rgba(255,255,255,0.10);
      padding: 2px 6px;
      border-radius: 10px;
    }

    /* ============================================================
      HEADER
    ============================================================ */
    .header{
      position: sticky;
      top: 0;
      z-index: 50;
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 14px;
      padding: 14px 18px;
      background: rgba(8, 12, 20, 0.75);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border);
    }

    .brand{
      display:flex;
      align-items:center;
      gap: 12px;
      min-width: 240px;
    }

    .logo{
      width: 48px;
      height: 48px;
      border-radius: 16px;
      display:grid;
      place-items:center;
      background: linear-gradient(135deg, rgba(96,165,250,0.18), rgba(74,222,128,0.12));
      border: 1px solid var(--border);
      box-shadow: var(--shadow2);
      font-size: 20px;
      user-select:none;
    }

    .brand-title{
      margin:0;
      font-size: 1.1rem;
      letter-spacing: -0.02em;
      font-weight: 900;
      line-height: 1.05;
    }
    .brand-sub{
      color: var(--muted);
      font-size: 0.88rem;
      margin-top: 3px;
      line-height: 1.1;
    }

    .actions{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: flex-end;
      align-items:center;
    }

    .btn{
      cursor:pointer;
      user-select:none;
      border: 1px solid var(--border2);
      background: var(--btn);
      color: var(--text);
      border-radius: 14px;
      padding: 10px 12px;
      font-weight: 850;
      letter-spacing: -0.01em;
      transition: transform 0.08s ease, background 0.15s ease, opacity 0.15s ease, border-color 0.15s ease;
    }

    .btn:hover{ transform: translateY(-1px); background: var(--btn2); }
    .btn:active{ transform: translateY(0px); }
    .btn:disabled{ opacity: 0.50; cursor: not-allowed; transform:none; }

    .btn-primary{
      background: rgba(74,222,128,0.14);
      border-color: rgba(74,222,128,0.35);
    }
    .btn-primary:hover{ background: rgba(74,222,128,0.18); }

    .btn-secondary{
      background: rgba(96,165,250,0.12);
      border-color: rgba(96,165,250,0.38);
    }
    .btn-secondary:hover{ background: rgba(96,165,250,0.16); }

    .btn-danger{
      background: rgba(251,113,133,0.12);
      border-color: rgba(251,113,133,0.35);
    }
    .btn-danger:hover{ background: rgba(251,113,133,0.16); }

    /* ============================================================
      LAYOUT
    ============================================================ */
    .wrap{
      max-width: 1450px;
      margin: 0 auto;
      padding: 18px;
    }

    .grid{
      display:grid;
      grid-template-columns: 1.05fr 0.95fr;
      gap: 16px;
    }

    @media (max-width: 1100px){
      .grid{ grid-template-columns: 1fr; }
    }

    .panel{
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,0.055), transparent 52%),
                  rgba(16, 24, 39, 0.52);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .panel-h{
      padding: 14px 14px 12px 14px;
      border-bottom: 1px solid var(--border);
      display:flex;
      align-items:flex-start;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }

    .panel-h h2{
      margin:0;
      font-size: 1.1rem;
      font-weight: 900;
      letter-spacing: -0.02em;
    }

    .pills{
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: flex-end;
      align-items:center;
    }

    .pill{
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.05);
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 0.86rem;
      color: var(--muted);
      white-space: nowrap;
    }
    .pill strong{ color: var(--text); }

    /* ============================================================
      DRAFT UI
    ============================================================ */
    .draft-top{
      padding: 12px 14px;
      border-bottom: 1px solid var(--border);
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    @media (max-width: 760px){
      .draft-top{ grid-template-columns: 1fr; }
    }

    .team{
      border: 1px solid var(--border);
      border-radius: var(--radius2);
      background: rgba(0,0,0,0.16);
      padding: 10px;
    }

    .team-head{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 8px;
    }

    .team-name{
      font-weight: 950;
      letter-spacing: -0.02em;
    }
    .team-meta{
      font-size: 0.86rem;
      color: var(--muted);
    }

    .chips{
      display:flex;
      flex-wrap: wrap;
      gap: 8px;
      min-height: 64px;
    }

    .chip{
      display:flex;
      align-items:center;
      gap: 8px;
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 6px 10px;
      background: rgba(255,255,255,0.05);
    }

    .chip img{
      width: 28px;
      height: 28px;
      border-radius: 999px;
      object-fit: cover;
      border: 1px solid rgba(255,255,255,0.16);
    }

    .chip .cname{
      font-weight: 900;
      font-size: 0.9rem;
      letter-spacing: -0.01em;
    }

    .chip .ctag{
      font-size: 0.78rem;
      color: var(--muted);
      margin-top: 2px;
    }

    .draft-mid{
      padding: 12px 14px;
      border-bottom: 1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }

    .hint{
      color: var(--muted);
      font-size: 0.92rem;
      line-height: 1.35;
      max-width: 700px;
    }

    .toggle{
      display:flex;
      align-items:center;
      gap: 10px;
      font-size: 0.92rem;
      color: var(--muted);
      user-select:none;
    }
    .toggle input{ transform: scale(1.15); }

    .pack{
      padding: 12px 14px 14px 14px;
    }

    .pack-head{
      display:flex;
      align-items:flex-end;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }

    .pack-title{
      font-weight: 950;
      letter-spacing: -0.02em;
      font-size: 1.02rem;
    }

    .pack-sub{
      font-size: 0.9rem;
      color: var(--muted);
      margin-top: 4px;
    }

    .search{
      display:flex;
      align-items:center;
      gap: 8px;
      border: 1px solid var(--border);
      border-radius: 999px;
      background: rgba(255,255,255,0.05);
      padding: 6px 10px;
      min-width: 240px;
    }

    .search input{
      width: 100%;
      background: transparent;
      border: none;
      outline: none;
      color: var(--text);
      font-size: 0.95rem;
    }

    .grid6{
      display:grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap: 12px;
    }
    @media (max-width: 1100px){
      .grid6{ grid-template-columns: repeat(2, minmax(0,1fr)); }
    }
    @media (max-width: 650px){
      .grid6{ grid-template-columns: 1fr; }
    }

    .card{
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(0,0,0,0.12));
      overflow:hidden;
      box-shadow: var(--shadow2);
      min-height: 330px;
      display:flex;
      flex-direction: column;
      transition: transform 0.12s ease, border-color 0.15s ease, opacity 0.15s ease;
    }

    .card:hover{
      transform: translateY(-2px);
      border-color: rgba(255,255,255,0.22);
    }

    .card.disabled{
      opacity: 0.50;
      pointer-events: none;
      transform:none;
    }

    .thumb{
  height: 160px;
  border-bottom: 1px solid var(--border);
  background: rgba(255,255,255,0.03);
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 8px;
}

.thumb img{
  max-width: 100%;
  max-height: 100%;
  object-fit: contain;
  display: block;
}

    .badge{
      position:absolute;
      top: 10px;
      left: 10px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(0,0,0,0.35);
      backdrop-filter: blur(6px);
      font-size: 0.82rem;
      color: rgba(255,255,255,0.92);
    }

    .body{
      padding: 12px;
      display:flex;
      flex-direction: column;
      gap: 10px;
      flex:1;
    }

    .name-row{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
    }

    .car-name{
      font-weight: 950;
      letter-spacing: -0.02em;
      font-size: 1.03rem;
    }

    .car-class{
      font-size: 0.82rem;
      color: var(--muted);
      border: 1px solid var(--border);
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(255,255,255,0.04);
    }

    .stats{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }

    .stat{
      border: 1px solid var(--border);
      border-radius: 12px;
      background: rgba(255,255,255,0.04);
      padding: 8px;
    }

    .stat .k{
      font-size: 0.75rem;
      color: var(--muted);
    }
    .stat .v{
      font-weight: 950;
      font-size: 1.0rem;
      letter-spacing: -0.01em;
    }

    .foot{
      padding: 12px;
      border-top: 1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
    }

    .small{
      color: var(--muted);
      font-size: 0.86rem;
      line-height: 1.25;
    }

    /* ============================================================
      RACE UI
    ============================================================ */
    .race-wrap{
      padding: 12px 14px 14px 14px;
    }

    .canvas-wrap{
      position: relative;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow:hidden;
      background: rgba(0,0,0,0.16);
    }

    canvas{ display:block; width: 100%; height:auto; }

    .overlay{
      position:absolute;
      inset: 0;
      display:grid;
      place-items:center;
      pointer-events:none;
      background: radial-gradient(900px 500px at 50% 30%, rgba(0,0,0,0.30), rgba(0,0,0,0.55));
    }
    .overlay.hidden{ display:none; }

    .overlay-card{
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.35);
      border-radius: 18px;
      padding: 14px 16px;
      text-align:center;
      max-width: 460px;
      box-shadow: var(--shadow);
    }
    .overlay-card .t{
      font-weight: 950;
      font-size: 1.15rem;
      margin-bottom: 6px;
      letter-spacing: -0.02em;
    }
    .overlay-card .s{
      color: var(--muted);
      font-size: 0.95rem;
      line-height: 1.35;
    }

    .race-bottom{
      padding: 12px 14px 14px 14px;
      border-top: 1px solid var(--border);
      display:grid;
      gap: 12px;
    }

    .row2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 760px){
      .row2{ grid-template-columns: 1fr; }
    }

    .box{
      border: 1px solid var(--border);
      border-radius: var(--radius2);
      background: rgba(0,0,0,0.14);
      padding: 10px;
      overflow:hidden;
    }

    .box h3{
      margin:0 0 10px 0;
      font-size: 1.0rem;
      font-weight: 950;
      letter-spacing: -0.02em;
    }

    table{
      width: 100%;
      border-collapse: collapse;
      font-size: 0.92rem;
    }

    th, td{
      padding: 10px 8px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
      text-align:left;
      vertical-align: middle;
    }

    th{
      color: var(--muted);
      font-weight: 900;
      font-size: 0.86rem;
      letter-spacing: -0.01em;
    }

    tr:last-child td{ border-bottom:none; }

    .pos{
      width: 44px;
      font-weight: 950;
    }

    .teamDot{
      display:inline-block;
      width: 10px;
      height: 10px;
      border-radius: 999px;
      margin-right: 8px;
      vertical-align: middle;
    }

    .pill-inline{
      display:inline-block;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.04);
      color: var(--muted);
      font-size: 0.80rem;
      margin-left: 8px;
    }

    .footer{
      padding: 16px 18px;
      color: var(--muted);
      text-align:center;
      font-size: 0.9rem;
    }
  </style>
</head>

<body>
  <!-- ============================================================
    HEADER
  ============================================================ -->
  <header class="header">
    <div class="brand">
      <div class="logo">üèéÔ∏è</div>
      <div>
        <div class="brand-title">Draft Circuit Racing</div>
        <div class="brand-sub">Random 6-car packs ‚Ä¢ 4 picks each ‚Ä¢ Advanced track ‚Ä¢ Live leaderboard</div>
      </div>
    </div>

    <div class="actions">
      <button id="btnReset" class="btn btn-danger" type="button">Reset</button>
      <button id="btnAutoDraft" class="btn btn-secondary" type="button">Auto Draft</button>
      <button id="btnStart" class="btn btn-primary" type="button" disabled>Start Race</button>
    </div>
  </header>

  <div class="wrap">
    <div class="grid">
      <!-- ========================================================
        DRAFT PANEL
      ========================================================= -->
      <section class="panel">
        <div class="panel-h">
          <h2>Draft</h2>
          <div class="pills">
            <div class="pill" id="pillTurn">Turn: <strong>Player 1</strong></div>
            <div class="pill" id="pillPicks">Picks: <strong>0/4 ‚Ä¢ 0/4</strong></div>
            <div class="pill" id="pillPack">Pack: <strong>1</strong></div>
          </div>
        </div>

        <div class="draft-top">
          <div class="team">
            <div class="team-head">
              <div class="team-name">Player 1</div>
              <div class="team-meta" id="p1Meta">0 / 4 cars</div>
            </div>
            <div class="chips" id="p1Chips"></div>
          </div>

          <div class="team">
            <div class="team-head">
              <div class="team-name">Player 2</div>
              <div class="team-meta" id="p2Meta">0 / 4 cars</div>
            </div>
            <div class="chips" id="p2Chips"></div>
          </div>
        </div>

        <div class="draft-mid">
          <div class="hint">
            Each pick shows <b>6 random cars</b> from your database. Cars already drafted won‚Äôt appear again.
            Add/rename car images in <code>/cars</code> and update the <code>CAR_DB</code> list in this file.
          </div>

          <div class="toggle" title="If enabled, the game will try to avoid offering extremely unbalanced packs.">
            <label>
              <input id="togglePackBalance" type="checkbox" checked />
              Balanced Packs
            </label>
          </div>

          <div class="toggle" title="Slight randomness in driving line / tiny mistakes.">
            <label>
              <input id="toggleMicroChaos" type="checkbox" checked />
              Micro Variance
            </label>
          </div>
        </div>

        <div class="pack">
          <div class="pack-head">
            <div>
              <div class="pack-title">Current Pack (Pick 1 of 8)</div>
              <div class="pack-sub" id="packSubtitle">Player 1: choose 1 of the 6 cars below.</div>
            </div>

            <div class="search" title="Filter current pack by name/class">
              üîé <input id="searchInput" placeholder="Search this pack..." />
            </div>
          </div>

          <div class="grid6" id="packGrid"></div>
        </div>
      </section>

      <!-- ========================================================
        RACE PANEL
      ========================================================= -->
      <section class="panel">
        <div class="panel-h">
          <h2>Race</h2>
          <div class="pills">
            <div class="pill" id="pillStatus">Status: <strong>Drafting</strong></div>
            <div class="pill" id="pillTime">Time: <strong>0:00 / 2:00</strong></div>
            <div class="pill" id="pillLap">Lap: <strong>‚Äì</strong></div>
          </div>
        </div>

        <div class="race-wrap">
          <div class="canvas-wrap">
            <canvas id="canvas" width="1400" height="560"></canvas>

            <div class="overlay" id="overlay">
              <div class="overlay-card">
                <div class="t" id="overlayTitle">Ready</div>
                <div class="s" id="overlaySubtitle">
                  Draft <b>4 cars</b> for each player to enable <b>Start Race</b>.<br/>
                  Tip: click <b>Auto Draft</b> if you want to watch instantly.
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="race-bottom">
          <div class="row2">
            <div class="box">
              <h3>Live Leaderboard</h3>
              <div id="liveBoard" class="small">No race yet.</div>
            </div>

            <div class="box">
              <h3>Lap Times</h3>
              <div id="lapTimes" class="small">No race yet.</div>
            </div>
          </div>

          <div class="box">
            <h3>Final Results</h3>
            <div id="results" class="small">No race yet.</div>
          </div>
        </div>
      </section>
    </div>

    <div class="footer">
      Static HTML/CSS/JS ‚Ä¢ Put images in <code>/cars</code> ‚Ä¢ Edit <code>CAR_DB</code> in this file
    </div>
  </div>

  <script>
    /* ============================================================
      SECTION 1 ‚Ä¢ CAR DATABASE
      ------------------------------------------------------------
      You can add as many cars as you want here.

      REQUIRED FIELDS:
        id: unique string
        name: display name
        cls: class tag (GT, Track, Hyper, etc)
        topSpeed: mph (this is your "speed" stat)
        zeroToSixty: seconds (0‚Äì60 time)
        bhp: horsepower (used subtly for mid-range pull)
        handling: 0..100 (cornering ability)
        img: filename inside /cars folder

      EXAMPLE IMAGE PATH:
        img: "falcon.png"  -> file at /cars/falcon.png

      NOTE:
        The drafting system will keep working as you add more cars.
    ============================================================ */

    const CAR_DB = [
      { id:"murcielago1",  name:"2001 Lamborghini Murcielago",  cls:"GT",     topSpeed:205, zeroToSixty:3.6, bhp:572, handling:86, img:"murcielago1.png" },
      { id:"golfgti1",   name:"2014 Volkswagen Golf GTI",   cls:"GT",     topSpeed:152, zeroToSixty:6.2, bhp:226, handling:81, img:"golfgti1.png" },
      { id:"golfgti2",  name:"2010 Volkswagen Golf GTI",  cls:"GT",  topSpeed:149, zeroToSixty:6.7, bhp:207, handling:78, img:"golfgti2.png" },
      { id:"cuprar",   name:"2002 SEAT Leon Cupra R",   cls:"GT",     topSpeed:150, zeroToSixty:7.0, bhp:210, handling:82, img:"cuprar1.png" },
      { id:"plaid1",   name:"2024 Tesla Model S Plaid",   cls:"GT",  topSpeed:199, zeroToSixty:1.99, bhp:1020, handling:93, img:"plaid1.png" },
      { id:"i30n1", name:"2019 Hyundai i30 N TCR", cls:"Track",  topSpeed:163, zeroToSixty:5.2, bhp:349, handling:99, img:"i30n1.png" },

      { id:"m31",   name:"2012 BMW M3",   cls:"GT",     topSpeed:155, zeroToSixty:4.3, bhp:414, handling:86, img:"m31.png" },
      { id:"cobra1",  name:"2020 Ford Mustang Cobra Jet 1400",  cls:"Track",  topSpeed:179, zeroToSixty:1.5, bhp:1400, handling:62, img:"cobra1.png" },
      { id:"919evo1",    name:"2018 Porsche 919 Hybrid Evo",    cls:"Track",  topSpeed:230, zeroToSixty:2.1,bhp:1160, handling:115, img:"919evo1.png" },
      { id:"jesko1",   name:"2024 Koenigsegg Jesko Absolut",   cls:"GT",     topSpeed:311, zeroToSixty:2.3,bhp:1280, handling:98, img:"jesko1.png" },

      /* Add more cars below (just keep unique ids) */
      { id:"amgone1",    name:"2023 Mercedes-AMG One",    cls:"Track",     topSpeed:219, zeroToSixty:2.9,bhp:1049, handling:110, img:"amgone1.png" },
      { id:"gt21",   name:" 2021 Porsche 911 GT2 RS Manthey Performance Kit",   cls:"Track",  topSpeed:211, zeroToSixty:2.7,bhp:690, handling:105, img:"gt21.png" },
      { id:"p11",   name:"2017 McLaren P1 LM",   cls:"GT",     topSpeed:214, zeroToSixty:2.4,bhp:986, handling:105, img:"p11.png" },
      { id:"amggt1",  name:"2020 Mercedes-AMG GT Black Series",  cls:"GT",  topSpeed:202, zeroToSixty:3.1,bhp:720, handling:104, img:"amggt1.png" },

      { id:"gt3rs1",   name:"2022 Porsche 911 GT3 RS (992)",   cls:"GT",  topSpeed:184, zeroToSixty:3.0, bhp:518, handling:105, img:"gt3rs1.png" },
      { id:"svj1",  name:"2018 Lamborghini Aventador SVJ",  cls:"GT",     topSpeed:217, zeroToSixty:2.8,bhp:759, handling:104, img:"svj1.png" },
      { id:"sr81",     name:"2011 Radical SR8 RX",     cls:"Track",  topSpeed:178, zeroToSixty:2.7,bhp:430, handling:107, img:"sr81.png" },
      { id:"gt2rs1",   name:"2017 Porsche 911 GT2 RS (991)",   cls:"GT",     topSpeed:211, zeroToSixty:2.7,bhp:690, handling:102, img:"gt2rs1.png" },
      { id:"sr82",   name:"2009 Radical SR8LM",   cls:"Track",     topSpeed:178, zeroToSixty:2.7,bhp:457, handling:108, img:"sr82.png" },
      { id:"gt3rs2",   name:"2021 Porsche 911 GT3 RS Manthey Performance Kit",   cls:"Track",     topSpeed:177, zeroToSixty:3.0,bhp:512, handling:105, img:"gt3rs2.png" },
      { id:"huracan1",   name:"2017 Lamborghini Hurac√°n Performante",   cls:"GT",   topSpeed:202, zeroToSixty:2.8,bhp:631, handling:102, img:"huracan1.png" },
      { id:"9181",   name:"2014 Porsche 918 Spyder",   cls:"GT",   topSpeed:214, zeroToSixty:2.4,bhp:889, handling:100, img:"9181.png" },
      { id:"wrx1",   name:"2017 Subaru WRX STI Type RA NBR",   cls:"Track",   topSpeed:180, zeroToSixty:3.0,bhp:600, handling:100, img:"wrx1.png" },
      { id:"gt41",   name:"2023 Porsche 718 Cayman GT4 RS Manthey Performance",   cls:"Track",   topSpeed:196, zeroToSixty:3.2,bhp:493, handling:104, img:"gt41.png" },
      { id:"gtb1",   name:"2023 Ferrari 296 GTB",   cls:"GT",   topSpeed:207, zeroToSixty:2.3,bhp:819, handling:99, img:"gtb1.png" },
      { id:"pista1",   name:"2019 Ferrari 488 Pista",   cls:"GT",   topSpeed:213, zeroToSixty:2.7,bhp:710, handling:100, img:"pista1.png" },
      { id:"nevera1",   name:"2023 Rimac Nevera",   cls:"GT",   topSpeed:258, zeroToSixty:1.75,bhp:1914, handling:97, img:"nevera1.png" },
      { id:"viper1",   name:"2017 Dodge Viper ACR (Mk V)",   cls:"GT",   topSpeed:177, zeroToSixty:3.3,bhp:645, handling:98, img:"viper1.png" },
      { id:"zr11",   name:"2019 Chevrolet Corvette ZR1 (C7)",   cls:"GT",   topSpeed:214, zeroToSixty:2.85,bhp:755, handling:98, img:"zr11.png" },
      { id:"gtpro1",   name:"2019 Mercedes-Benz AMG GT R Pro",   cls:"GT",   topSpeed:198, zeroToSixty:3.5,bhp:577, handling:98, img:"gtpro1.png" },
      { id:"ep91",   name:"2017 Nio EP9",   cls:"Track",   topSpeed:194, zeroToSixty:2.7,bhp:1360, handling:104, img:"ep91.png" },
      { id:"z061",   name:"2023 Chevrolet Corvette Z06 Z07 Package (C8)",   cls:"GT",   topSpeed:189, zeroToSixty:2.6,bhp:670, handling:97, img:"z061.png" },
      { id:"720s1",   name:"2019 McLaren 720s",   cls:"GT",   topSpeed:212, zeroToSixty:2.7,bhp:710, handling:97, img:"720s1.png" },
      { id:"gtr1",   name:"2014 Nissan GT-R Nismo (R35)",   cls:"GT",   topSpeed:196, zeroToSixty:2.7,bhp:592, handling:97, img:"gtr1.png" },
      { id:"apollo1",   name:"2009 Gumpert Apollo Sport",   cls:"GT",   topSpeed:223, zeroToSixty:2.9,bhp:690, handling:96, img:"apollo1.png" },
      { id:"srt1",   name:"2010 Dodge Viper SRT-10 ACR",   cls:"GT",   topSpeed:202, zeroToSixty:3.4,bhp:600, handling:96, img:"srt1.png" },
      { id:"carrera1",   name:"2025 Porsche 911 Carrera GTS",   cls:"GT",   topSpeed:194, zeroToSixty:2.6,bhp:534, handling:94, img:"carrera1.png" },
      { id:"carreragt1",   name:"2006 Porsche Carrera GT",   cls:"GT",   topSpeed:207, zeroToSixty:3.5,bhp:612, handling:93, img:"carreragt1.png" },
      { id:"m41",   name:"2022 BMW M4 CSL",   cls:"GT",   topSpeed:191, zeroToSixty:3.6,bhp:543, handling:94, img:"m41.png" },
      { id:"taycan1",   name:"2024 Porsche Taycan Turbo GT Weissach Package",   cls:"GT",   topSpeed:190, zeroToSixty:2.1,bhp:1093, handling:97, img:"taycan1.png" },
      { id:"lfa1",   name:"2011 Lexus LFA Nurburgring Package",   cls:"GT",   topSpeed:202, zeroToSixty:3.5,bhp:562, handling:95, img:"lfa1.png" },
      { id:"c631",   name:"2025 mercedes-Benz AMG GT 63 Pro",   cls:"GT",   topSpeed:197, zeroToSixty:3.2,bhp:604, handling:96, img:"c631.png" },
      { id:"d81",   name:"2004 Donkervoort D8 RS",   cls:"GT",   topSpeed:154, zeroToSixty:3.5,bhp:350, handling:94, img:"d81.png" },
      { id:"aventador1",   name:"2015 Lamborghini Aventador LP750-4 SV",   cls:"GT",   topSpeed:218, zeroToSixty:2.6,bhp:740, handling:98, img:"aventador1.png" },
      { id:"camaro1",   name:"2018 Chevrolet Camaro ZL1 1LE Package",   cls:"GT",   topSpeed:193, zeroToSixty:3.5,bhp:650, handling:94, img:"camaro1.png" },
      { id:"turbos1",   name:"2026 Porsche 911 Turbo S",   cls:"GT",   topSpeed:205, zeroToSixty:2.4,bhp:701, handling:97, img:"turbos1.png" },
      { id:"m42",   name:"2025 BMW M4 CS",   cls:"GT",   topSpeed:188, zeroToSixty:2.9,bhp:542, handling:93, img:"m42.png" },
      { id:"mcmurtry1",   name:"2022 McMurtry Sp√©irling",   cls:"Track",   topSpeed:185, zeroToSixty:1.4,bhp:1000, handling:113, img:"mcmurtry1.png" },
      { id:"valkyrie1",   name:"2023 Aston Martin Valkyrie",   cls:"Track",   topSpeed:220, zeroToSixty:2.4,bhp:1139, handling:110, img:"valkyrie1.png" },
      { id:"toyota1",   name:"2019 Toyota TS050 Hybrid",   cls:"Track",   topSpeed:216, zeroToSixty:2.3,bhp:986, handling:113, img:"toyota1.png" },
      { id:"gt31",   name:"2025 Porsche 911 GT3 R LMGT3",   cls:"Track",   topSpeed:186, zeroToSixty:2.9,bhp:550, handling:102, img:"gt31.png" },
      { id:"project81",   name:"2019 Jaguar XE SV Project 8",   cls:"GT",   topSpeed:200, zeroToSixty:3.3,bhp:592, handling:93, img:"project81.png" }

    ];
  
    
    /* ============================================================
      SECTION 2 ‚Ä¢ DOM HOOKS
    ============================================================ */
    const el = {
      btnReset: document.getElementById("btnReset"),
      btnAutoDraft: document.getElementById("btnAutoDraft"),
      btnStart: document.getElementById("btnStart"),

      pillTurn: document.getElementById("pillTurn"),
      pillPicks: document.getElementById("pillPicks"),
      pillPack: document.getElementById("pillPack"),

      p1Chips: document.getElementById("p1Chips"),
      p2Chips: document.getElementById("p2Chips"),
      p1Meta: document.getElementById("p1Meta"),
      p2Meta: document.getElementById("p2Meta"),

      togglePackBalance: document.getElementById("togglePackBalance"),
      toggleMicroChaos: document.getElementById("toggleMicroChaos"),

      packGrid: document.getElementById("packGrid"),
      searchInput: document.getElementById("searchInput"),
      packSubtitle: document.getElementById("packSubtitle"),

      pillStatus: document.getElementById("pillStatus"),
      pillTime: document.getElementById("pillTime"),
      pillLap: document.getElementById("pillLap"),

      canvas: document.getElementById("canvas"),
      overlay: document.getElementById("overlay"),
      overlayTitle: document.getElementById("overlayTitle"),
      overlaySubtitle: document.getElementById("overlaySubtitle"),

      liveBoard: document.getElementById("liveBoard"),
      lapTimes: document.getElementById("lapTimes"),
      results: document.getElementById("results"),
    };

    const ctx = el.canvas.getContext("2d");

    /* ============================================================
      SECTION 3 ‚Ä¢ CONSTANTS & UTILITIES
    ============================================================ */
    const PICKS_PER_PLAYER = 8;
    const PACK_SIZE = 6;
    const TOTAL_PICKS = PICKS_PER_PLAYER * 2; // 8 picks total

    const RACE_TARGET_MS = 600000; // ~2 min target
    const FRAME_DT_MIN = 8;
    const FRAME_DT_MAX = 40;

    function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }
    function lerp(a,b,t){ return a + (b-a)*t; }
    function invLerp(a,b,v){ return (v-a)/(b-a); }
    function rand(min,max){ return min + Math.random()*(max-min); }
    function randInt(min,max){ return Math.floor(rand(min, max+1)); }

    function formatTime(ms){
      const s = Math.max(0, Math.floor(ms/1000));
      const m = Math.floor(s/60);
      const r = s%60;
      return `${m}:${String(r).padStart(2,"0")}`;
    }

    // Quick stable id
    function uid(){
      return Math.random().toString(16).slice(2) + Date.now().toString(16);
    }

    /* ============================================================
      SECTION 4 ‚Ä¢ GAME STATE
    ============================================================ */
    const state = {
      // Draft
      pool: [],            // array of cars with picked flag
      currentPack: [],     // 6 cars shown right now
      pickNumber: 0,       // 0..7
      turn: 1,             // 1 or 2
      p1: [],
      p2: [],

      // Options
      balancedPacks: true,
      microChaos: true,

      // Race
      racing: false,
      startMs: 0,
      lastMs: 0,
      simMs: 0,
      raceDurationMs: RACE_TARGET_MS,
      lapsTarget: 0,

      track: null,
      racers: [],
      images: new Map(),

      // UI / computed
      lastLeaderboardHtml: "",
      lastLapTimesHtml: "",
    };

    /* ============================================================
      SECTION 5 ‚Ä¢ INITIALIZE POOL
    ============================================================ */
    function createPool(){
      return CAR_DB.map(c => ({...c, picked:false}));
    }

    /* ============================================================
      SECTION 6 ‚Ä¢ IMAGE LOADING
    ============================================================ */
    function loadImage(path){
      return new Promise((resolve) => {
        const img = new Image();
        img.onload = () => resolve(img);
        img.onerror = () => resolve(null);
        img.src = path;
      });
    }

    async function preloadImagesForCars(cars){
      const tasks = cars.map(async c => {
        const path = "cars/" + c.img;
        if (state.images.has(path)) return;
        const img = await loadImage(path);
        state.images.set(path, img);
      });
      await Promise.all(tasks);
    }

    async function preloadAll(){
      await preloadImagesForCars(state.pool);
    }

    /* ============================================================
      SECTION 7 ‚Ä¢ DRAFT LOGIC (Random 6 each pick)
    ============================================================ */

    function updateOptionsFromUI(){
      state.balancedPacks = !!el.togglePackBalance.checked;
      state.microChaos = !!el.toggleMicroChaos.checked;
    }

    function currentPlayerName(){
      return state.turn === 1 ? "Player 1" : "Player 2";
    }

    function draftComplete(){
      return state.p1.length === PICKS_PER_PLAYER && state.p2.length === PICKS_PER_PLAYER;
    }

    function remainingCars(){
      return state.pool.filter(c => !c.picked);
    }

    function scoreCarForBalance(car){
      // A rough "overall" score to avoid extremely stacked packs
      // We mainly consider top speed, 0-60, handling
      // BHP is subtle support
      const speedScore = (car.topSpeed - 180) / 80;           // ~0..1
      const accelScore = clamp((4.6 - car.zeroToSixty) / 2.2, 0, 1); // better if lower time
      const handlingScore = clamp((car.handling - 50) / 50, 0, 1);
      const bhpScore = clamp((car.bhp - 300) / 450, 0, 1);

      return speedScore*0.40 + accelScore*0.30 + handlingScore*0.25 + bhpScore*0.05;
    }

    function makeRandomPack(){
      // Must return up to PACK_SIZE cars, no repeats, from remaining
      const rem = remainingCars();
      if (rem.length <= PACK_SIZE) return rem.slice();

      // If balancedPacks enabled:
      // We pick a candidate pack several times and choose one
      // whose average score is closest to overall remaining average.
      if (state.balancedPacks){
        const scores = rem.map(scoreCarForBalance);
        const avgAll = scores.reduce((a,b)=>a+b,0) / Math.max(1,scores.length);

        let bestPack = null;
        let bestDelta = Infinity;

        const tries = 24; // more tries -> more balanced, still random
        for (let t=0; t<tries; t++){
          // random sample
          const sample = [];
          const used = new Set();
          while(sample.length < PACK_SIZE){
            const idx = randInt(0, rem.length-1);
            if (used.has(idx)) continue;
            used.add(idx);
            sample.push(rem[idx]);
          }

          const avgPack = sample.map(scoreCarForBalance).reduce((a,b)=>a+b,0) / PACK_SIZE;
          const delta = Math.abs(avgPack - avgAll);
          if (delta < bestDelta){
            bestDelta = delta;
            bestPack = sample;
          }
        }
        return bestPack || rem.slice(0, PACK_SIZE);
      }

      // else: purely random sample
      const pack = [];
      const used = new Set();
      while(pack.length < PACK_SIZE){
        const idx = randInt(0, rem.length-1);
        if (used.has(idx)) continue;
        used.add(idx);
        pack.push(rem[idx]);
      }
      return pack;
    }

    function advanceTurn(){
      // Alternate turns strictly: P1, P2, P1, P2...
      state.turn = (state.turn === 1) ? 2 : 1;
    }

    function nextPack(){
      updateOptionsFromUI();

      // If draft done, no more packs
      if (draftComplete()){
        state.currentPack = [];
        return;
      }

      state.currentPack = makeRandomPack();

      // Preload pack images quickly (optional)
      preloadImagesForCars(state.currentPack);
    }

    function pickCar(carId){
      if (state.racing) return;
      if (draftComplete()) return;

      const car = state.pool.find(c => c.id === carId);
      if (!car || car.picked) return;

      // Pick for current turn
      if (state.turn === 1){
        if (state.p1.length >= PICKS_PER_PLAYER) return;
        state.p1.push({...car});
      } else {
        if (state.p2.length >= PICKS_PER_PLAYER) return;
        state.p2.push({...car});
      }

      // Mark picked in pool
      car.picked = true;

      state.pickNumber++;
      advanceTurn();

      // Generate next pack unless draft complete
      nextPack();
      renderAll();

      // Enable start if draft complete
      if (draftComplete()){
        el.btnStart.disabled = false;
        el.overlay.classList.remove("hidden");
        el.overlayTitle.textContent = "Ready to Race";
        el.overlaySubtitle.innerHTML = "Press <b>Start Race</b> to begin the 2-minute race.";
      }
    }

    function autoDraft(){
      if (state.racing) return;

      // Draft until complete with simple "preference"
      // P1: handling bias, P2: straight-line bias
      while(!draftComplete()){
        nextPack();

        const pack = state.currentPack.slice();

        // choose best in this pack for that player
        let best = null;
        let bestScore = -Infinity;

        for (const c of pack){
          const accel = (4.6 - c.zeroToSixty) * 12;
          const speed = (c.topSpeed - 180) * 1.1;
          const handle = (c.handling - 50) * 1.3;
          const bhp = (c.bhp - 300) * 0.04;

          let s;
          if (state.turn === 1){
            s = handle*1.5 + accel*1.1 + speed*0.6 + bhp*0.4;
          } else {
            s = speed*1.4 + accel*1.1 + handle*0.6 + bhp*0.45;
          }

          if (s > bestScore){
            bestScore = s;
            best = c;
          }
        }

        if (!best) break;
        pickCar(best.id);
      }
      renderAll();
    }

    /* ============================================================
      SECTION 8 ‚Ä¢ DRAFT UI RENDER
    ============================================================ */

    function setPill(node, label, strongText){
      node.innerHTML = `${label}: <strong>${strongText}</strong>`;
    }

    function renderTeamChips(){
      el.p1Chips.innerHTML = "";
      el.p2Chips.innerHTML = "";

      function addChip(container, car){
        const div = document.createElement("div");
        div.className = "chip";

        const img = document.createElement("img");
        img.src = "cars/" + car.img;
        img.alt = car.name;

        const meta = document.createElement("div");
        meta.innerHTML = `
          <div class="cname">${car.name}</div>
          <div class="ctag">${car.cls} ‚Ä¢ ${car.topSpeed}mph ‚Ä¢ H${car.handling}</div>
        `;

        div.appendChild(img);
        div.appendChild(meta);
        container.appendChild(div);
      }

      state.p1.forEach(c => addChip(el.p1Chips, c));
      state.p2.forEach(c => addChip(el.p2Chips, c));

      el.p1Meta.textContent = `${state.p1.length} / ${PICKS_PER_PLAYER} cars`;
      el.p2Meta.textContent = `${state.p2.length} / ${PICKS_PER_PLAYER} cars`;
    }

    function packMatchesSearch(car, q){
      if (!q) return true;
      const s = q.toLowerCase().trim();
      return (
        car.name.toLowerCase().includes(s) ||
        car.cls.toLowerCase().includes(s)
      );
    }

    function renderPack(){
      el.packGrid.innerHTML = "";

      const q = el.searchInput.value || "";
      const filtered = state.currentPack.filter(c => packMatchesSearch(c, q));

      const pickIdx = clamp(state.pickNumber + 1, 1, TOTAL_PICKS);
      const subtitle =
        draftComplete()
          ? "Draft complete."
          : `${currentPlayerName()}: choose 1 of the 6 cars below.`;
      el.packSubtitle.textContent = subtitle;

      for (const car of filtered){
        const card = document.createElement("div");
        card.className = "card" + (car.picked ? " disabled" : "");

        const thumb = document.createElement("div");
        thumb.className = "thumb";
        thumb.innerHTML = `
          <img src="cars/${car.img}" alt="${car.name}">
          <div class="badge">${car.cls}</div>
        `;

        const body = document.createElement("div");
        body.className = "body";

        const nameRow = document.createElement("div");
        nameRow.className = "name-row";
        nameRow.innerHTML = `
          <div class="car-name">${car.name}</div>
          <div class="car-class">${car.picked ? "Drafted" : "Available"}</div>
        `;

        const stats = document.createElement("div");
        stats.className = "stats";
        stats.innerHTML = `
          <div class="stat"><div class="k">Top Speed</div><div class="v">${car.topSpeed} mph</div></div>
          <div class="stat"><div class="k">0‚Äì60</div><div class="v">${car.zeroToSixty.toFixed(2)} s</div></div>
          <div class="stat"><div class="k">BHP</div><div class="v">${car.bhp}</div></div>
          <div class="stat"><div class="k">Handling</div><div class="v">${car.handling}</div></div>
        `;

        const foot = document.createElement("div");
        foot.className = "foot";

        const note = document.createElement("div");
        note.className = "small";
        note.innerHTML = `Click to draft for <b>${currentPlayerName()}</b>`;

        const btn = document.createElement("button");
        btn.className = "btn btn-secondary";
        btn.type = "button";
        btn.textContent = "Draft";
        btn.disabled = car.picked || state.racing || draftComplete();

        btn.addEventListener("click", (ev) => {
          ev.stopPropagation();
          pickCar(car.id);
        });

        foot.appendChild(note);
        foot.appendChild(btn);

        body.appendChild(nameRow);
        body.appendChild(stats);

        card.appendChild(thumb);
        card.appendChild(body);
        card.appendChild(foot);

        card.addEventListener("click", () => {
          if (btn.disabled) return;
          pickCar(car.id);
        });

        el.packGrid.appendChild(card);
      }

      // If filter hides all, show message
      if (filtered.length === 0){
        const div = document.createElement("div");
        div.className = "small";
        div.style.padding = "12px";
        div.textContent = "No cars match your search in this pack.";
        el.packGrid.appendChild(div);
      }

      setPill(el.pillPack, "Pack", String(pickIdx));
    }

    function renderDraftPills(){
      setPill(el.pillTurn, "Turn", `Player ${state.turn}`);
      setPill(el.pillPicks, "Picks", `${state.p1.length}/${PICKS_PER_PLAYER} ‚Ä¢ ${state.p2.length}/${PICKS_PER_PLAYER}`);

      el.btnStart.disabled = !draftComplete() || state.racing;

      if (!state.racing){
        if (draftComplete()){
          el.overlay.classList.remove("hidden");
          el.overlayTitle.textContent = "Ready to Race";
          el.overlaySubtitle.innerHTML = "Press <b>Start Race</b> to begin.";
        } else {
          el.overlay.classList.remove("hidden");
          el.overlayTitle.textContent = "Ready";
          el.overlaySubtitle.innerHTML = "Draft <b>4 cars</b> each to enable <b>Start Race</b>.";
        }
      }
    }

    function renderAll(){
      renderTeamChips();
      renderDraftPills();
      renderPack();
    }

    /* ============================================================
      SECTION 9 ‚Ä¢ TRACK (Advanced multi-corner circuit)
      ------------------------------------------------------------
      We build a track from waypoints and automatically compute:
        - segment lengths
        - a parametric distance -> position mapping
        - curvature severity per sample
      Then we can compute corner speed caps using handling.
    ============================================================ */

    function v2(x,y){ return {x,y}; }
    function add(a,b){ return {x:a.x+b.x, y:a.y+b.y}; }
    function sub(a,b){ return {x:a.x-b.x, y:a.y-b.y}; }
    function mul(a,s){ return {x:a.x*s, y:a.y*s}; }
    function len(a){ return Math.hypot(a.x,a.y); }
    function norm(a){
      const l = len(a) || 1e-9;
      return {x:a.x/l, y:a.y/l};
    }
    function dot(a,b){ return a.x*b.x + a.y*b.y; }
    function cross(a,b){ return a.x*b.y - a.y*b.x; }
    function angleBetween(a,b){
      const na = norm(a);
      const nb = norm(b);
      const d = clamp(dot(na, nb), -1, 1);
      return Math.acos(d);
    }

    function buildTrack(){
      // Track in canvas coordinates.
      // This is intentionally not an oval.
      // It has long straights, sweepers, chicanes, hairpins, etc.

      const W = el.canvas.width;
      const H = el.canvas.height;

      // These waypoints create a complex loop.
      // You can add more points to make it even more technical.
      const pts = [

  // ==================================================
  // SUPER LONG MAIN STRAIGHT (power + top speed zone)
  // ==================================================

  v2(40, 120),
  v2(180, 120),
  v2(320, 120),
  v2(460, 120),
  v2(600, 120),
  v2(740, 120),
  v2(880, 120),
  v2(1020, 120),
  v2(1160, 120),
  v2(1300, 120),   // VERY long straight

  // ==================================================
  // FAST RIGHT SWEEPER (barely lift)
  // ==================================================

  v2(1340, 190),
  v2(1300, 320),

  // ==================================================
  // HEAVY BRAKING HAIRPIN
  // ==================================================

  v2(1100, 400),
  v2(850, 400),

  // ==================================================
  // LONG EXIT STRAIGHT (acceleration test)
  // ==================================================

  v2(650, 400),
  v2(450, 400),
  v2(250, 400),

  // ==================================================
  // FLOWING LEFT BEND
  // ==================================================

  v2(200, 320),
  v2(230, 220),

  // ==================================================
  // SHORT STRAIGHT
  // ==================================================

  v2(380, 200),
  v2(560, 200),

  // ==================================================
  // TECHNICAL COMPLEX (handling zone)
  // ==================================================

  v2(600, 280),
  v2(680, 200),
  v2(760, 300),
  v2(840, 220),

  // ==================================================
  // LONG BACK STRAIGHT
  // ==================================================

  v2(960, 190),
  v2(1100, 190),
  v2(1240, 190),

  // ==================================================
  // FINAL SWEEPERS BACK TO START
  // ==================================================

  v2(1320, 260),
  v2(1080, 300),
  v2(820, 260),
  v2(560, 230),
  v2(300, 180)
];

      // Auto-close
      const loop = pts.slice();
      // ensure last point not same as first; we will treat looped path
      // We'll do periodic indexing.

      // Build polyline segments and lengths
      const segs = [];
      let total = 0;

      for (let i=0;i<loop.length;i++){
        const a = loop[i];
        const b = loop[(i+1) % loop.length];
        const d = len(sub(b,a));
        segs.push({ a, b, d, cum0: total, cum1: total + d });
        total += d;
      }

      // We will sample curvature along the path at multiple points.
      // Curvature severity computed via turning angle at vertices.
      // We'll define a "corner severity" per segment by looking at
      // angle between incoming and outgoing vectors at vertex.
      const vertexSeverity = new Array(loop.length).fill(0);

      for (let i=0;i<loop.length;i++){
        const prev = loop[(i-1 + loop.length) % loop.length];
        const curr = loop[i];
        const next = loop[(i+1) % loop.length];

        const vin = sub(curr, prev);
        const vout = sub(next, curr);

        const ang = angleBetween(vin, vout); // 0=straight, pi=reverse
        // Map to severity:
        // small angle -> low severity, larger angle -> high severity
        // We'll clamp extremes.
        const sev = clamp(ang / Math.PI, 0, 1); // 0..1
        vertexSeverity[i] = sev;
      }

      // For each segment, assign severity blending its endpoints
for (let i=0;i<segs.length;i++){
  const sevA = vertexSeverity[i];
  const sevB = vertexSeverity[(i+1) % vertexSeverity.length];

  let sev = clamp((sevA + sevB)*0.5, 0, 1);

  // sharpen real corners, keep sweepers fast
  sev = Math.pow(sev, 1.4);

  segs[i].severity = sev;
}

      // Define a fictional "real" lap length in meters.
      // We map pixels to meters by choosing a scale so lap times feel realistic.
      // We'll tune pxToM so that typical lap times land ~25-35s, then set lapsTarget
      // so total ~120s.
      const lapPixels = total;
      const lapMeters = 6750; // ~3.4 km lap (fictional)
      const pxToM = lapMeters / lapPixels;

      // Provide helper: distance (meters) -> canvas position + heading + severity
      function sampleAtDistMeters(distM){
        // Convert meters to pixels along polyline
        const dPx = (distM / pxToM) % lapPixels;
        const sPx = (dPx + lapPixels) % lapPixels;

        // Find segment containing sPx
        // (linear scan ok; small seg count)
        let seg = segs[0];
        for (let i=0;i<segs.length;i++){
          if (sPx >= segs[i].cum0 && sPx < segs[i].cum1){
            seg = segs[i];
            break;
          }
        }

        const t = (sPx - seg.cum0) / Math.max(1e-9, seg.d);
        const p = add(seg.a, mul(sub(seg.b, seg.a), t));

        // Heading vector
        const dir = norm(sub(seg.b, seg.a));
        const heading = Math.atan2(dir.y, dir.x);

        // Severity: use seg severity + extra boost near vertices
        // so braking zones feel localized.
        const sev = seg.severity;

        return { x:p.x, y:p.y, heading, severity: sev };
      }

      return {
        W, H,
        pts: loop,
        segs,
        lapPixels,
        lapMeters,
        pxToM,
        sampleAtDistMeters
      };
    }

    /* ============================================================
      SECTION 10 ‚Ä¢ VEHICLE PERFORMANCE MODEL
      ------------------------------------------------------------
      User spec:
        - speed = top speed (mph)
        - 0‚Äì60 affects acceleration (realistic curve from 60 to top speed)
        - handling affects cornering

      Implementation:
        - Convert mph -> m/s cap (Vmax)
        - Calibrate low-speed acceleration so 0‚Äì60 is roughly achieved
        - Use diminishing acceleration curve above 60 (drag-limited)
        - Add subtle bhp influence to mid-range (60-140 mph)
        - Corner speed cap:
            VcornerCap = Vmax * (base + handlingFactor) * trackCornerFactor
          where trackCornerFactor depends on severity:
            severity 0 => 1.0
            severity 1 => ~0.55
          and handlingFactor depends on handling (0..100):
            handling 70 => smaller corner cap
            handling 98 => much higher corner cap
    ============================================================ */

    function mphToMs(mph){ return mph * 0.44704; }

    function computePerf(car){
      const vmax = mphToMs(car.topSpeed);

      // 0‚Äì60 calibration
      const v60 = mphToMs(60);

      // Base acceleration needed to do 0-60 in given time (ignoring traction limits)
      const t060 = clamp(car.zeroToSixty, 2.2, 6.5);
      const a0 = v60 / t060; // m/s^2

      // Diminishing acceleration exponent:
      // higher top speed => more drag, larger exponent
      const exp = lerp(1.25, 1.75, clamp((car.topSpeed - 200)/80, 0, 1));

      // Mid-range pull factor from BHP:
      // higher bhp gives better accel above 60 (but diminishing returns)
      const bhp = clamp(car.bhp, 250, 900);
      const bhpBoost = 1 + Math.sqrt((bhp - 250) / 650) * 0.22; // up to ~+22%

      // Handling maps to corner retention
      const h = clamp(car.handling, 40, 100);
      const handlingFactor = clamp(
  (car.handling - 65) / 50,
  0,
  1
); // 40->0.25, 100->0.85

      return {
        vmax,
        v60,
        a0,
        exp,
        bhpBoost,
        handlingFactor
      };
    }

    function accelAtSpeed(perf, v){

  const vmax = perf.vmax;
  const v60  = perf.v60;

  // Accel power purely from 0‚Äì60
  const baseAccel = perf.a0 * 1.70;

  // Realistic traction cap
  const tractionLimit = 11.5;

  let a;

  // =====================================
  // BELOW 60 MPH ‚Üí dominated by 0‚Äì60
  // =====================================

  if(v < v60){

    const t = v / v60;

    a = baseAccel * (1 - 0.05*t);

    a = Math.min(a, tractionLimit);
  }

  // =====================================
  // ABOVE 60 MPH ‚Üí still mostly 0‚Äì60 based
  // (top speed DOES NOT weaken accel)
  // =====================================

  else {

    const x = v / vmax;

    // Soft drag curve (very gentle)
    a = baseAccel * Math.pow(1 - x, 0.7);

    // BHP midrange effect
    const midPull = Math.exp(-Math.pow((x - 0.55)/0.25, 2));

    a *= (1 + (perf.bhpBoost - 1) * midPull);

    // minimum push
    a = Math.max(a, 0.18);
  }

  return a;
}
    function cornerCap(perf, severity){

  const h = clamp(perf.handlingFactor, 0.25, 0.95);

  const minCorner = 13;   // bad grip
  const maxCorner = 42;   // elite grip

  let gripSpeed = lerp(
  minCorner,
  maxCorner,
  Math.pow(h, 1.15)
);

  const sevCurve = Math.pow(severity, 0.81);

  const cap = gripSpeed * lerp(1.0, 0.42, sevCurve);

  return cap;
      }
    /* ============================================================
      SECTION 11 ‚Ä¢ RACE SIM
      ------------------------------------------------------------
      We simulate each car as a particle moving along track distance (meters).
      Each racer:
        - distance (m)
        - velocity (m/s)
        - lap count + lap start time
        - lap times array
      We stop when:
        - time >= 2 minutes OR leader reaches lapsTarget (computed)
    ============================================================ */

    function buildRacers(){
      const all = [...state.p1, ...state.p2];

      return all.map((car, idx) => {
        const perf = computePerf(car);
        const team = (idx < PICKS_PER_PLAYER) ? 1 : 2;
        const spritePath = "cars/" + car.img;

        return {
          id: uid(),
          car,
          team,
          perf,

          // sim
          distance: 0,
          v: 0,

          // lap tracking
          lap: 0,
          lapTimes: [],
          lastLapStartMs: 0,

          // micro variance / driving line offset
          laneOffset: 0,

          // sprite cached
          spritePath,
          sprite: state.images.get(spritePath) || null,
        };
      });
    }

    function estimateLapTimeSeconds(racer){
      // Roughly estimate lap time from performance and track severity average.
      // We'll sample a few points to compute average corner cap impact.
      const track = state.track;
      const samples = 180;
      let sumCap = 0;

      for (let i=0; i<samples; i++){
        const s = (i / samples) * track.lapMeters;
        const sm = track.sampleAtDistMeters(s);
        const cap = cornerCap(racer.perf, sm.severity);
        sumCap += cap;
      }

      const avgCap = sumCap / samples;

      // Average speed is a fraction of avg cap due to accel/braking transitions.
      // Tuning:
      const avgSpeed = avgCap * 0.72;

      return track.lapMeters / Math.max(1, avgSpeed);
    }

    function computeLapsTarget(){
      // target around 2 minutes -> choose lapsTarget based on mid racer estimate
      const racers = state.racers;
      if (!racers.length) return 6;

      const mid = racers[Math.floor(racers.length/2)];
      const lapSec = estimateLapTimeSeconds(mid);
      const raceSec = state.raceDurationMs / 1000;

      const laps = clamp(Math.round(raceSec / lapSec), 4, 10);
      return laps;
    }

    function stepRacer(r, dtMs){

  const dt = dtMs / 1000;
  const track = state.track;

  // -------------------------------------------------
  // Look ahead to anticipate braking zones
  // -------------------------------------------------

  const lookAhead = clamp(r.v * 1.15, 30, 95);

  const here  = track.sampleAtDistMeters(r.distance);
  const ahead = track.sampleAtDistMeters(r.distance + lookAhead);

  let sev = clamp(
    lerp(here.severity, ahead.severity, 0.6),
    0,
    1
  );

  // -------------------------------------------------
  // Detect straights (no corner influence)
  // -------------------------------------------------

  const isStraight = sev < 0.06;

  // -------------------------------------------------
  // Speed caps
  // -------------------------------------------------

  const vmax = r.perf.vmax;

  let vcap = isStraight
    ? vmax
    : cornerCap(r.perf, sev);

  // -------------------------------------------------
  // Minimum corner speed from handling (NOT on straights)
  // -------------------------------------------------

  if(!isStraight){

    const h = clamp(r.perf.handlingFactor, 0.25, 0.95);

    const minCornerMs = lerp(
      5.5,     // ~12 mph poor handling
      27.0,    // ~60 mph elite handling
      Math.pow((h - 0.25) / 0.7, 1.4)
    );

    vcap = Math.max(vcap, minCornerMs);
  }

  // -------------------------------------------------
  // BRAKING (only if above cap)
  // -------------------------------------------------

if(r.v > vcap){

  const h = clamp(r.perf.handlingFactor, 0.25, 0.95);

  const excess = r.v - vcap;

  // Handling controls how well speed is retained
  const gripRetention = lerp(0.88, 0.97, h);  

  // Progressive braking curve (gentle first, harsh if crazy fast)
  const brakeLoss = Math.pow(excess, 1.15) * dt * 0.85;

  r.v -= brakeLoss;

  // Grip lets you keep some overspeed naturally
  r.v = Math.max(r.v, vcap * gripRetention);
}

  // -------------------------------------------------
  // ACCELERATION (free on straights + exits)
  // -------------------------------------------------

  else {

    const accel = accelAtSpeed(r.perf, r.v);

    r.v += accel * dt;

    if(r.v > vmax) r.v = vmax;
  }

  // -------------------------------------------------
  // MICRO CHAOS (tiny realism noise)
  // -------------------------------------------------

  if(state.microChaos){
    const jitter = (Math.random() - 0.5) * sev * 0.008;
    r.v *= (1 + jitter);
  }

  // -------------------------------------------------
  // Clamp and move
  // -------------------------------------------------

  r.v = clamp(r.v, 0, vmax);

  r.distance += r.v * dt;

  // -------------------------------------------------
  // LAP TRACKING
  // -------------------------------------------------

  const lapMeters = track.lapMeters;
  const newLap = Math.floor(r.distance / lapMeters);

  if(newLap > r.lap){

    const lapTime = state.simMs - r.lastLapStartMs;

    if(lapTime > 1000){
      r.lapTimes.push(lapTime);
    }

    r.lap = newLap;
    r.lastLapStartMs = state.simMs;
  }
                         }

    function stepAll(dtMs){
      for (const r of state.racers){
        stepRacer(r, dtMs);
      }
    }

    function leader(){
      return state.racers.slice().sort((a,b)=>b.distance-a.distance)[0];
    }

    /* ============================================================
      SECTION 12 ‚Ä¢ DRAWING
      ------------------------------------------------------------
      We draw:
        - background grid
        - track polyline + road width
        - start/finish
        - cars with sprites along path
        - mini HUD leaderboard on canvas
    ============================================================ */

    function ensureRoundRect(){
      if (!CanvasRenderingContext2D.prototype.roundRect){
        CanvasRenderingContext2D.prototype.roundRect = function(x,y,w,h,r){
          const rr = Math.min(r, w/2, h/2);
          this.beginPath();
          this.moveTo(x+rr, y);
          this.arcTo(x+w, y, x+w, y+h, rr);
          this.arcTo(x+w, y+h, x, y+h, rr);
          this.arcTo(x, y+h, x, y, rr);
          this.arcTo(x, y, x+w, y, rr);
          this.closePath();
          return this;
        };
      }
    }
    ensureRoundRect();

    function drawBackground(track){
      ctx.clearRect(0,0,track.W,track.H);

      // grid
      ctx.save();
      ctx.globalAlpha = 0.16;
      ctx.strokeStyle = "#ffffff";
      ctx.lineWidth = 1;
      for (let x=0; x<track.W; x+=42){
        ctx.beginPath();
        ctx.moveTo(x,0);
        ctx.lineTo(x,track.H);
        ctx.stroke();
      }
      for (let y=0; y<track.H; y+=42){
        ctx.beginPath();
        ctx.moveTo(0,y);
        ctx.lineTo(track.W,y);
        ctx.stroke();
      }
      ctx.restore();
    }

    function drawTrack(track){
      const pts = track.pts;

      // Road (thick)
      ctx.save();
      ctx.lineCap = "round";
      ctx.lineJoin = "round";

      ctx.strokeStyle = "rgba(0,0,0,0.40)";
      ctx.lineWidth = 54;
      ctx.beginPath();
      for (let i=0;i<pts.length;i++){
        const p = pts[i];
        if (i===0) ctx.moveTo(p.x, p.y);
        else ctx.lineTo(p.x, p.y);
      }
      ctx.closePath();
      ctx.stroke();

      // Edge line
      ctx.strokeStyle = "rgba(255,255,255,0.10)";
      ctx.lineWidth = 6;
      ctx.beginPath();
      for (let i=0;i<pts.length;i++){
        const p = pts[i];
        if (i===0) ctx.moveTo(p.x, p.y);
        else ctx.lineTo(p.x, p.y);
      }
      ctx.closePath();
      ctx.stroke();

      // Center line (dashed)
      ctx.strokeStyle = "rgba(255,255,255,0.08)";
      ctx.lineWidth = 2;
      ctx.setLineDash([10,10]);
      ctx.beginPath();
      for (let i=0;i<pts.length;i++){
        const p = pts[i];
        if (i===0) ctx.moveTo(p.x, p.y);
        else ctx.lineTo(p.x, p.y);
      }
      ctx.closePath();
      ctx.stroke();
      ctx.setLineDash([]);

      ctx.restore();

      // Start/finish marker near first point segment
      const start = pts[0];
      const next = pts[1];
      const dir = norm(sub(next, start));
      const n = { x: -dir.y, y: dir.x };

      ctx.save();
      ctx.strokeStyle = "rgba(255,255,255,0.90)";
      ctx.lineWidth = 4;
      ctx.beginPath();
      ctx.moveTo(start.x + n.x * -18, start.y + n.y * -18);
      ctx.lineTo(start.x + n.x *  18, start.y + n.y *  18);
      ctx.stroke();

      ctx.fillStyle = "rgba(255,255,255,0.72)";
      ctx.font = "900 14px ui-sans-serif, system-ui";
      ctx.fillText("START / FINISH", start.x + 20, start.y - 16);
      ctx.restore();
    }

    function drawCar(r){
      const track = state.track;
      const sample = track.sampleAtDistMeters(r.distance);
      const heading = sample.heading;

      // offset perpendicular for separation
      const nx = Math.cos(heading + Math.PI/2);
      const ny = Math.sin(heading + Math.PI/2);

      const x = sample.x + nx * r.laneOffset;
      const y = sample.y + ny * r.laneOffset;

      const img = r.sprite || state.images.get(r.spritePath);

      // sprite size
      const w = 54;
      const h = 30;

      ctx.save();
      ctx.translate(x, y);
      ctx.rotate(heading);

      // shadow
      ctx.globalAlpha = 0.25;
      ctx.fillStyle = "#000";
      ctx.beginPath();
      ctx.ellipse(0, 10, w*0.46, h*0.34, 0, 0, Math.PI*2);
      ctx.fill();
      ctx.globalAlpha = 1;

      if (img){
        ctx.drawImage(img, -w/2, -h/2, w, h);
      } else {
        ctx.fillStyle = "rgba(255,255,255,0.85)";
        ctx.fillRect(-w/2, -h/2, w, h);
      }

      // team marker dot
      ctx.globalAlpha = 0.95;
      ctx.fillStyle = (r.team===1) ? "rgba(96,165,250,0.95)" : "rgba(74,222,128,0.95)";
      ctx.beginPath();
      ctx.arc(-w/2 + 8, -h/2 + 8, 4, 0, Math.PI*2);
      ctx.fill();
      ctx.globalAlpha = 1;

      ctx.restore();

      // label
      ctx.save();
      ctx.fillStyle = "rgba(255,255,255,0.78)";
      ctx.font = "900 12px ui-sans-serif, system-ui";
      ctx.fillText(r.car.name, x + 18, y - 14);
      ctx.restore();
    }

    function drawCanvasLeaderboard(){
      const sorted = state.racers.slice().sort((a,b)=>b.distance-a.distance);

      const x = 18;
      const y = 18;
      const w = 330;
      const rowH = 22;

      ctx.save();
      ctx.globalAlpha = 0.92;
      ctx.fillStyle = "rgba(0,0,0,0.30)";
      ctx.strokeStyle = "rgba(255,255,255,0.12)";
      ctx.lineWidth = 1;
      ctx.roundRect(x, y, w, 20 + sorted.length*rowH + 12, 14);
      ctx.fill();
      ctx.stroke();
      ctx.restore();

      ctx.save();
      ctx.fillStyle = "rgba(255,255,255,0.86)";
      ctx.font = "950 13px ui-sans-serif, system-ui";
      ctx.fillText("LIVE", x+12, y+18);

      ctx.font = "850 12px ui-sans-serif, system-ui";
      for (let i=0;i<sorted.length;i++){
        const r = sorted[i];
        const yy = y + 38 + i*rowH;

        ctx.fillStyle = (r.team===1) ? "rgba(96,165,250,0.95)" : "rgba(74,222,128,0.95)";
        ctx.fillRect(x+12, yy-10, 6, 6);

        ctx.fillStyle = "rgba(255,255,255,0.84)";
        ctx.fillText(`${i+1}. ${r.car.name}`, x+24, yy-4);

        const lap = r.lap;
        ctx.fillStyle = "rgba(255,255,255,0.62)";
        ctx.fillText(`L${lap}`, x+w-44, yy-4);
      }
      ctx.restore();
    }

    function drawScene(){
      const track = state.track;
      drawBackground(track);
      drawTrack(track);

      // draw cars in distance order so leader overlays nicely
      const order = state.racers.slice().sort((a,b)=>a.distance-b.distance);
      for (const r of order) drawCar(r);

      drawCanvasLeaderboard();
    }

    function drawStatic(){
      state.track = buildTrack();
      drawBackground(state.track);
      drawTrack(state.track);

      ctx.save();
      ctx.fillStyle = "rgba(255,255,255,0.60)";
      ctx.font = "950 18px ui-sans-serif, system-ui";
      ctx.fillText("Draft cars to race", 22, state.track.H - 22);
      ctx.restore();
    }

    /* ============================================================
      SECTION 13 ‚Ä¢ LIVE UI (Leaderboard + Lap Times)
    ============================================================ */

    function renderLiveLeaderboard(){
      const sorted = state.racers.slice().sort((a,b)=>b.distance-a.distance);

      let html = `<table>
        <thead>
          <tr>
            <th class="pos">#</th>
            <th>Car</th>
            <th>Team</th>
            <th>Lap</th>
            <th>Speed</th>
          </tr>
        </thead>
        <tbody>
      `;

      for (let i=0;i<sorted.length;i++){
        const r = sorted[i];
        const teamColor = (r.team===1) ? "var(--p1)" : "var(--p2)";
        const mph = (r.v / 0.44704);

        html += `
          <tr>
            <td class="pos">${i+1}</td>
            <td><span class="teamDot" style="background:${teamColor}"></span><b>${r.car.name}</b> <span class="pill-inline">${r.car.cls}</span></td>
            <td>Player ${r.team}</td>
            <td>${r.lap}/${state.lapsTarget}</td>
            <td>${mph.toFixed(0)} mph</td>
          </tr>
        `;
      }

      html += `</tbody></table>`;

      if (html !== state.lastLeaderboardHtml){
        el.liveBoard.innerHTML = html;
        state.lastLeaderboardHtml = html;
      }
    }

    function renderLapTimes(){
      // Show each car best lap + last lap
      const sorted = state.racers.slice().sort((a,b)=>b.distance-a.distance);

      let html = `<table>
        <thead>
          <tr>
            <th>Car</th>
            <th>Best</th>
            <th>Last</th>
            <th>Laps</th>
          </tr>
        </thead>
        <tbody>
      `;

      for (const r of sorted){
        const best = r.lapTimes.length ? Math.min(...r.lapTimes) : null;
        const last = r.lapTimes.length ? r.lapTimes[r.lapTimes.length-1] : null;

        html += `
          <tr>
            <td><b>${r.car.name}</b></td>
            <td>${best ? formatTime(best) : "‚Äî"}</td>
            <td>${last ? formatTime(last) : "‚Äî"}</td>
            <td>${r.lapTimes.length}</td>
          </tr>
        `;
      }

      html += `</tbody></table>`;

      if (html !== state.lastLapTimesHtml){
        el.lapTimes.innerHTML = html;
        state.lastLapTimesHtml = html;
      }
    }

    function renderFinalResults(){
      const sorted = state.racers.slice().sort((a,b)=>b.distance-a.distance);

      let html = `<table>
        <thead>
          <tr>
            <th class="pos">#</th>
            <th>Car</th>
            <th>Team</th>
            <th>Distance</th>
            <th>Best Lap</th>
            <th>Laps</th>
          </tr>
        </thead>
        <tbody>
      `;

      for (let i=0;i<sorted.length;i++){
        const r = sorted[i];
        const best = r.lapTimes.length ? Math.min(...r.lapTimes) : null;

        html += `
          <tr>
            <td class="pos">${i+1}</td>
            <td><b>${r.car.name}</b> <span class="pill-inline">${r.car.cls}</span></td>
            <td>Player ${r.team}</td>
            <td>${(r.distance/1000).toFixed(2)} km</td>
            <td>${best ? formatTime(best) : "‚Äî"}</td>
            <td>${r.lap}</td>
          </tr>
        `;
      }

      html += `</tbody></table>`;
      el.results.innerHTML = html;
    }

    /* ============================================================
      SECTION 14 ‚Ä¢ RACE CONTROL
    ============================================================ */

    async function startRace(){
      if (state.racing) return;
      if (!draftComplete()) return;

      updateOptionsFromUI();

      state.track = buildTrack();
      state.racers = buildRacers();

      // Preload all racer images
      await preloadImagesForCars(state.racers.map(r => ({img: r.car.img})));

      // refresh sprites
      for (const r of state.racers){
        r.sprite = state.images.get(r.spritePath) || null;
      }

      state.lapsTarget = computeLapsTarget();

      state.racing = true;
      state.startMs = performance.now();
      state.lastMs = state.startMs;
      state.simMs = 0;

      // UI
      setPill(el.pillStatus, "Status", "Racing");
      setPill(el.pillTime, "Time", `0:00 / ${formatTime(state.raceDurationMs)}`);
      setPill(el.pillLap, "Lap", `Lead: 0/${state.lapsTarget}`);

      el.overlay.classList.add("hidden");
      el.btnStart.disabled = true;

      el.liveBoard.innerHTML = `<div class="small">Race in progress...</div>`;
      el.lapTimes.innerHTML = `<div class="small">Race in progress...</div>`;
      el.results.innerHTML = `<div class="small">Race in progress...</div>`;

      // Initialize lap start times at 0
      for (const r of state.racers){
        r.lastLapStartMs = 0;
      }

      requestAnimationFrame(frame);
    }

    function endRace(){
      state.racing = false;

      const win = leader();
      setPill(el.pillStatus, "Status", "Finished");

      el.overlay.classList.remove("hidden");
      el.overlayTitle.textContent = `Winner: ${win.car.name}`;
      el.overlaySubtitle.innerHTML = `Player <b>${win.team}</b> wins. Press <b>Reset</b> to draft again.`;

      renderFinalResults();
    }

    function frame(now){
      if (!state.racing) return;

      const dt = clamp(now - state.lastMs, FRAME_DT_MIN, FRAME_DT_MAX);
      state.lastMs = now;

      state.simMs += dt;

      // step simulation
      stepAll(dt);

      // update pills
      setPill(el.pillTime, "Time", `${formatTime(state.simMs)} / ${formatTime(state.raceDurationMs)}`);

      const lead = leader();
      setPill(el.pillLap, "Lap", `Lead: ${lead.lap}/${state.lapsTarget}`);

      // draw
      drawScene();

      // live UI refresh (not every frame to reduce DOM churn)
      // update ~6 times per second
      if (Math.floor(state.simMs/160) !== Math.floor((state.simMs-dt)/160)){
        renderLiveLeaderboard();
        renderLapTimes();
      }

      // end conditions:
      // - time elapsed OR leader reaches lapsTarget
      if (state.simMs >= state.raceDurationMs || lead.lap >= state.lapsTarget){
        endRace();
        return;
      }

      requestAnimationFrame(frame);
    }

    /* ============================================================
      SECTION 15 ‚Ä¢ RESET / INIT
    ============================================================ */

    function reset(){
      state.pool = createPool();
      state.currentPack = [];
      state.pickNumber = 0;
      state.turn = 1;
      state.p1 = [];
      state.p2 = [];

      state.racing = false;
      state.startMs = 0;
      state.lastMs = 0;
      state.simMs = 0;
      state.lapsTarget = 0;

      state.track = buildTrack();
      state.racers = [];
      state.lastLeaderboardHtml = "";
      state.lastLapTimesHtml = "";

      el.btnStart.disabled = true;

      setPill(el.pillStatus, "Status", "Drafting");
      setPill(el.pillTime, "Time", `0:00 / ${formatTime(state.raceDurationMs)}`);
      setPill(el.pillLap, "Lap", "‚Äì");

      el.liveBoard.innerHTML = `<div class="small">No race yet.</div>`;
      el.lapTimes.innerHTML = `<div class="small">No race yet.</div>`;
      el.results.innerHTML = `<div class="small">No race yet.</div>`;

      el.overlay.classList.remove("hidden");
      el.overlayTitle.textContent = "Ready";
      el.overlaySubtitle.innerHTML = "Draft <b>4 cars</b> each to enable <b>Start Race</b>.";

      // generate first pack
      nextPack();
      renderAll();

      drawStatic();
    }

    /* ============================================================
      SECTION 16 ‚Ä¢ EVENT WIRES
    ============================================================ */
    el.btnReset.addEventListener("click", reset);
    el.btnAutoDraft.addEventListener("click", () => {
      autoDraft();
      renderAll();
    });
    el.btnStart.addEventListener("click", startRace);

    el.searchInput.addEventListener("input", () => {
      renderPack();
    });

    el.togglePackBalance.addEventListener("change", () => {
      updateOptionsFromUI();
      renderPack();
    });

    el.toggleMicroChaos.addEventListener("change", () => {
      updateOptionsFromUI();
    });

    /* ============================================================
      SECTION 17 ‚Ä¢ STARTUP
    ============================================================ */
    (async function init(){
      state.pool = createPool();
      await preloadAll();
      reset();
    })();

    /* ============================================================
      END OF FILE
      ------------------------------------------------------------
      Notes for you:
        1) Put your images into /cars/
        2) Update CAR_DB entries so img matches your filenames
        3) Add more cars by appending objects to CAR_DB
        4) The draft will automatically work with any number of cars
    ============================================================ */
  </script>
</body>
  </html>
